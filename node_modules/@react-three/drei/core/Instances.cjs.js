"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("@babel/runtime/helpers/extends"),t=require("three"),r=require("react"),n=require("@react-three/fiber"),a=require("react-merge-refs"),c=require("react-composer"),i=require("../helpers/deprecated.cjs.js");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function o(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var u=s(e),l=o(t),f=o(r),d=s(a),m=s(c);const y=new l.Matrix4,p=new l.Matrix4,h=[],x=new l.Mesh;class g extends l.Group{constructor(){super(),this.color=new l.Color("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return null==(e=this.instance.current)?void 0:e.geometry}raycast(e,t){const r=this.instance.current;if(!r)return;if(!r.geometry||!r.material)return;x.geometry=r.geometry;const n=r.matrixWorld,a=r.userData.instances.indexOf(this.instanceKey);if(!(-1===a||a>r.count)){r.getMatrixAt(a,y),p.multiplyMatrices(n,y),x.matrixWorld=p,r.material instanceof l.Material?x.material.side=r.material.side:x.material.side=r.material[0].side,x.raycast(e,h);for(let e=0,r=h.length;e<r;e++){const r=h[e];r.instanceId=a,r.object=this,t.push(r)}h.length=0}}}const M=f.createContext(null),b=new l.Matrix4,w=new l.Matrix4,v=new l.Matrix4,j=new l.Vector3,E=new l.Quaternion,A=new l.Vector3,O=f.forwardRef((({context:e,children:t,...r},a)=>{f.useMemo((()=>n.extend({PositionMesh:g})),[]);const c=f.useRef(),{subscribe:i,getParent:s}=f.useContext(e||M);return f.useLayoutEffect((()=>i(c)),[]),f.createElement("positionMesh",u.default({instance:s(),instanceKey:c,ref:d.default([a,c])},r),t)})),P=f.forwardRef((({children:e,range:t,limit:r=1e3,frames:a=1/0,...c},s)=>{const[{context:o,instance:m}]=f.useState((()=>{const e=f.createContext(null);return{context:e,instance:f.forwardRef(((t,r)=>f.createElement(O,u.default({context:e},t,{ref:r}))))}})),y=f.useRef(null),[p,h]=f.useState([]),[[x,g]]=f.useState((()=>{const e=new Float32Array(16*r);for(let t=0;t<r;t++)v.identity().toArray(e,16*t);return[e,new Float32Array([...new Array(3*r)].map((()=>1)))]}));f.useEffect((()=>{y.current.instanceMatrix.needsUpdate=!0}));let P=0,R=0;n.useFrame((()=>{if(a===1/0||P<a){y.current.updateMatrix(),y.current.updateMatrixWorld(),b.copy(y.current.matrixWorld).invert(),R=Math.min(r,void 0!==t?t:r,p.length),y.current.count=R,i.setUpdateRange(y.current.instanceMatrix,{offset:0,count:16*R}),i.setUpdateRange(y.current.instanceColor,{offset:0,count:3*R});for(let e=0;e<p.length;e++){const t=p[e].current;t.matrixWorld.decompose(j,E,A),w.compose(j,E,A).premultiply(b),w.toArray(x,16*e),y.current.instanceMatrix.needsUpdate=!0,t.color.toArray(g,3*e),y.current.instanceColor.needsUpdate=!0}P++}}));const U=f.useMemo((()=>({getParent:()=>y,subscribe:e=>(h((t=>[...t,e])),()=>h((t=>t.filter((t=>t.current!==e.current)))))})),[]);return f.createElement("instancedMesh",u.default({userData:{instances:p},matrixAutoUpdate:!1,ref:d.default([s,y]),args:[null,null,0],raycast:()=>null},c),f.createElement("instancedBufferAttribute",{attach:"instanceMatrix",count:x.length/16,array:x,itemSize:16,usage:l.DynamicDrawUsage}),f.createElement("instancedBufferAttribute",{attach:"instanceColor",count:g.length/3,array:g,itemSize:3,usage:l.DynamicDrawUsage}),"function"==typeof e?f.createElement(o.Provider,{value:U},e(m)):f.createElement(M.Provider,{value:U},e))})),R=f.forwardRef((function({meshes:e,children:t,...r},n){const a=Array.isArray(e);if(!a)for(const t of Object.keys(e))e[t].isMesh||delete e[t];return f.createElement("group",{ref:n},f.createElement(m.default,{components:(a?e:Object.values(e)).map((({geometry:e,material:t})=>f.createElement(P,u.default({key:e.uuid,geometry:e,material:t},r))))},(r=>a?t(...r):t(Object.keys(e).filter((t=>e[t].isMesh)).reduce(((e,t,n)=>({...e,[t]:r[n]})),{})))))}));exports.Instance=O,exports.Instances=P,exports.Merged=R;
